# Production Deployment Guide

This guide will help you deploy your Discuss Phoenix application to a VPS with Docker, Nginx, and SSL.

## üìã Prerequisites

- A VPS with Ubuntu 20.04+ (2GB RAM minimum, 4GB recommended)
- A domain name pointed to your VPS IP
- SSH access to your VPS

## üöÄ Quick Start

### 1. VPS Setup

SSH into your VPS and run the setup script:

```bash
# Clone the repository
git clone <your-repo-url> /opt/discuss
cd /opt/discuss

# Run VPS setup script
./scripts/setup-vps.sh
```

### 2. Environment Configuration

```bash
# Copy and edit environment file
cp .env.prod.template .env.prod
nano .env.prod
```

Fill in these required values:
- `POSTGRES_PASSWORD`: Strong database password
- `SECRET_KEY_BASE`: Use the one generated by setup script
- `PHX_HOST`: Your domain name (e.g., example.com)
- `PORT`: 4000 (default)

### 3. Nginx Configuration

```bash
# Copy nginx config
sudo cp nginx/discuss.conf /etc/nginx/sites-available/discuss

# Edit the config with your domain
sudo nano /etc/nginx/sites-available/discuss

# Enable the site
sudo ln -s /etc/nginx/sites-available/discuss /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4. SSL Certificate

```bash
# Get SSL certificate
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

### 5. Deploy Application

```bash
# Deploy the application
./deploy.sh deploy
```

## üõ†Ô∏è Management Commands

### Deployment Commands

```bash
./deploy.sh build      # Build production image
./deploy.sh deploy     # Full deployment
./deploy.sh migrate    # Run migrations
./deploy.sh logs       # View logs
./deploy.sh shell      # Access production shell
./deploy.sh stop       # Stop application
./deploy.sh restart    # Restart application
./deploy.sh status     # Check status
./deploy.sh clean      # Clean up resources
```

### Database Management

```bash
# Backup database
./deploy.sh backup-db

# Restore database
./deploy.sh restore-db backup_20231201_120000.sql
```

## üîß Configuration Details

### Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `POSTGRES_DB` | Database name | `discuss_prod` |
| `POSTGRES_USER` | Database user | `postgres` |
| `POSTGRES_PASSWORD` | Database password | `secure_password` |
| `SECRET_KEY_BASE` | Phoenix secret | Generated 64-char hex |
| `PHX_HOST` | Your domain | `example.com` |
| `PORT` | Application port | `4000` |
| `POOL_SIZE` | DB connection pool | `10` |

### Nginx Features

- SSL/TLS termination
- HTTP to HTTPS redirect
- WebSocket support for LiveView
- Gzip compression
- Security headers
- Rate limiting (configurable)
- Static file serving

### Docker Setup

- Multi-stage production build
- Optimized Alpine-based image
- Non-root user for security
- Health checks
- Automatic restarts
- Database connection pooling

## üîç Monitoring and Logs

### View Application Logs
```bash
./deploy.sh logs
```

### View Nginx Logs
```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### Check Container Status
```bash
./deploy.sh status
docker ps
```

### System Resources
```bash
htop
df -h
free -h
```

## üîß Troubleshooting

### Common Issues

1. **Database connection failed**
   - Check `.env.prod` configuration
   - Ensure database container is running: `docker ps`

2. **502 Bad Gateway**
   - Check if application is running: `./deploy.sh status`
   - Check nginx configuration: `sudo nginx -t`
   - Check application logs: `./deploy.sh logs`

3. **SSL certificate issues**
   - Ensure domain points to VPS IP
   - Check firewall: `sudo ufw status`
   - Retry certbot: `sudo certbot --nginx -d yourdomain.com`

4. **Out of memory**
   - Check system resources: `free -h`
   - Consider reducing `POOL_SIZE` in `.env.prod`
   - Add swap space if needed

### Emergency Recovery

```bash
# Stop everything and restart
./deploy.sh stop
./deploy.sh deploy

# Reset database (WARNING: loses data)
./deploy.sh clean
./deploy.sh deploy
```

## üìà Performance Optimization

### Database Optimization
- Monitor connection pool usage
- Adjust `POOL_SIZE` based on traffic
- Regular database maintenance

### Application Optimization
- Enable Gzip compression (already configured)
- Use CDN for static assets
- Monitor memory usage

### Nginx Optimization
- Adjust worker processes
- Tune buffer sizes
- Enable caching for static content

## üîí Security Considerations

- Regular system updates: `sudo apt update && sudo apt upgrade`
- Monitor logs for suspicious activity
- Keep SSL certificates updated (auto-renewal configured)
- Use strong passwords
- Limit SSH access
- Regular database backups

## üìä Scaling

### Vertical Scaling
- Increase VPS resources (CPU, RAM)
- Adjust database pool size
- Optimize database queries

### Horizontal Scaling
- Add multiple application containers
- Use load balancer
- Separate database server
- Use external cache (Redis)

## üÜò Support

If you encounter issues:
1. Check the logs: `./deploy.sh logs`
2. Verify configuration files
3. Check system resources
4. Review security logs: `sudo journalctl -u nginx`

Remember to backup your database regularly and test your deployment process in a staging environment first!
